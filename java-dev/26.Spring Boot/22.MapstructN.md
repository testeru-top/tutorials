---
tags: note
status: done
priority: 1
time: 2022-05-17 12:26
things:  "[ğŸ§Š](things:///show?id=JtkDsmtmq6Bd8ZbzKBJTW4)"
---


#### question
>ç¨‹åºä¸­æ˜¯å¦å¯ä»¥ç›´æ¥ä¸šåŠ¡ä»£ç æ“ä½œæ•°æ®åº“æ˜ å°„çš„å®ä½“ç±»ï¼Ÿä¼šä¸ä¼šæœ‰ä»€ä¹ˆé£é™©ï¼Ÿ
 

- [l] ç›´æ¥æ“ä½œæ•°æ®åº“è¡¨çš„å®ä½“ç±»å¯¹è±¡ï¼Œå¯¹åº”çš„å­—æ®µéƒ½æš´éœ²å‡ºæ¥
#### resolve
- [p] ä½¿ç”¨è‡ªå®šä¹‰çš„dtoè¿›è¡Œä¸šåŠ¡é€»è¾‘ç¼–å†™
- [p] ä½¿ç”¨beanæ‹·è´
  >dtoçš„å®ä½“ç±»ä¸entityçš„å®ä½“ç±»è¿›è¡Œè½¬æ¢


### DTOè¯´æ˜
- `data transform object`ï¼Œæ•°æ®ä¼ è¾“å¯¹è±¡
- [d] ç”¨æˆ·æ›´æ–°è‡ªå·±çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä¿®æ”¹å¯†ç çš„æ“ä½œ
```plantuml
@startuml
skinparam sequenceMessageAlign right
actor  Actor as Foo1
Foo1-> controller : request()
controller -> service : serviceMethod(dto)
service -> dao : dtoè½¬ä¸ºentityï¼Œè¿›è¡Œæ•°æ®åº“æ“ä½œ
@enduml

```

```
ç”¨æˆ·æäº¤é¡µé¢-->ActionFormæå–Formæ•°æ®-->æ„é€ å¹¶å¯¹UserDTOèµ‹å€¼-->
è°ƒç”¨ä¸šåŠ¡æ–¹æ³•changePassword(UserDTOdto)æŠŠDTOå¯¹è±¡ä¼ å…¥ä¸šåŠ¡æ–¹æ³•-->
ä¸šåŠ¡æ–¹æ³•å†…éƒ¨æŠŠUserDTOè½¬åŒ–ä¸ºEntity User-->è°ƒç”¨UserDAO.update(User)-->DAOè°ƒç”¨hibernateè¿›è¡ŒæŒä¹…åŒ–æ“ä½œ
```
- [b]  `DTO`: å‡¡æ˜¯è¦é€šè¿‡ç½‘ç»œä¼ è¾“çš„å¯¹è±¡ï¼Œéƒ½å½“åšæ˜¯DTOå¯¹è±¡
>æ¯”å¦‚ç”µå•†å¹³å°ä¸­ï¼Œç”¨æˆ·è¿›è¡Œä¸‹å•ï¼Œä¸‹å•åçš„æ•°æ®ï¼Œè®¢å•ä¼šå‘åˆ°OMS æˆ–è€… ERPç³»ç»Ÿï¼Œè¿™äº›å¯¹æ¥çš„è¿”å›å€¼ä»¥åŠå…¥å‚ä¹Ÿå«DTOå¯¹è±¡
>DTOå¯¹è±¡å¯¹å¤–ï¼ŒDTO å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦å˜æ›´ï¼Œå¹¶ä¸éœ€è¦æ˜ å°„ entity çš„å…¨éƒ¨å±æ€§ã€‚
- [b]  `entity`ï¼š`entity` æ˜¯å®ä½“ï¼Œä¼šåœ¨æ•°æ®åº“ä¸­å­˜åœ¨çš„å®é™…çš„è¡¨ï¼ŒåŒ…æ‹¬å®ƒçš„æ¯ä¸€ä¸ªå­—æ®µ
- [] beanæ‹·è´ï¼š DTOä¸ºç³»ç»Ÿä¸å¤–ç•Œäº¤äº’çš„æ¨¡å‹å¯¹è±¡ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæœ‰ä¸€ä¸ªæ­¥éª¤æ˜¯å°†DTOå¯¹è±¡è½¬åŒ–ä¸ºBOå¯¹è±¡æˆ–è€…æ˜¯æ™®é€šçš„entityå¯¹è±¡ï¼Œ`serviceå±‚å»å¤„ç†`

## Beanæ‹·è´
- [l] BeanUtils
>åœ¨SpringBooté¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨BeanUtils.copyPropertiesæ¥å®ç°å¯¹è±¡å±æ€§æ‹·è´ã€‚
  - [f] ç¼ºç‚¹ï¼šBeanUtils.copyPropertiesçš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œå¦‚æœå¯¹è±¡ä¸­çš„å­—æ®µå‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šå¯¼è‡´æ‹·è´å¤±è´¥ï¼Œå°±ä¼šåœ¨é¡¹ç›®ä¸­ç•™ä¸‹æ½œåœ¨çš„bugã€‚
- [l] Cglib
>æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶å¹¶ä¸”æƒ³æé«˜æ€§èƒ½å°±ç”¨*Cglibçš„BeanCopierè¿›è¡ŒBeanæ‹·è´*
>å…¶æ€§èƒ½è¦æ¯”Springçš„BeanUtilsï¼ŒApacheçš„BeanUtilså’ŒPropertyUtilsè¦å¥½å¾ˆå¤šï¼Œå°¤å…¶æ˜¯æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ã€‚
  - [f] ç¼ºç‚¹ï¼šCglibç”±äºJavaç‰ˆæœ¬åˆ°11ä¼šæœ‰warnè­¦å‘Šåœ¨å‘½ä»¤è¡Œï¼Œè™½ç„¶æ€§èƒ½æé«˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®ä½¿ç”¨

>é‚£é€‰æ‹©è°ï¼Ÿ
### mapstruct
>MapSturct æ˜¯ä¸€ä¸ªç”Ÿæˆç±»å‹å®‰å…¨ï¼Œ é«˜æ€§èƒ½ä¸”æ— ä¾èµ–çš„ JavaBean æ˜ å°„ä»£ç çš„æ³¨è§£å¤„ç†å™¨ï¼ˆannotation processorï¼‰ã€‚
- [b] [mapstructå®˜ç½‘](https://mapstruct.org/documentation/dev/reference/html/#setup)
  - [p] æ³¨è§£å¤„ç†å™¨
  - [p] å¯ä»¥ç”Ÿæˆ JavaBean ä¹‹é—´é‚£çš„æ˜ å°„ä»£ç 
  - [p] ç±»å‹å®‰å…¨ï¼Œ é«˜æ€§èƒ½ï¼Œ æ— ä¾èµ–æ€§

- [i] é€šè¿‡æ³¨è§£çš„æ–¹å¼å¸®æˆ‘ä»¬å®ç° _JavaBean_ ä¹‹é—´çš„è½¬æ¢

#### pomå¯¼å…¥
```xml
 <properties>
    <org.mapstruct.version>1.4.2.Final</org.mapstruct.version>
</properties>
<dependencies>
    <dependency>
        <groupId>org.mapstruct</groupId>
        <artifactId>mapstruct</artifactId>
        <version>${org.mapstruct.version}</version>
    </dependency>
</dependencies>
```

#### è½¬æ¢ç±»ç¼–å†™
- [p] ä½¿ç”¨mapperæ³¨è§£ï¼Œå¯¼å…¥çš„åŒ…ä¸ºmapstructçš„åŒ…
```java
package top.testeru.sbm.converter;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.Mappings;
import top.testeru.sbm.dto.UserDTO;
import top.testeru.sbm.entity.User;

import java.util.List;

/**
 * @program: springboot-turorials
 * @author: testeru.top
 * @description:
 * @Version 1.0
 * @create: 2022/5/17 9:06 PM
 */
//ç”Ÿæˆçš„æ˜ å°„å™¨æ˜¯ä¸€ä¸ªå•ä¾‹èŒƒå›´çš„ Spring beanï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€ç´¢@Autowired
@Mapper(componentModel = "spring")
public interface UserConverter {
    @Mappings({
            @Mapping(target = "id",source = "id"),
            @Mapping(target = "userName",source = "userName"),
            @Mapping(target = "password",source = "password"),
            @Mapping(target = "email",source = "email")
    })
    User userDtoForUser(UserDTO userDto);
    @Mappings({
            @Mapping(target = "id",source = "id"),
            @Mapping(target = "userName",source = "userName"),
            @Mapping(target = "password",source = "password"),
            @Mapping(target = "email",source = "email")
    })
    UserDTO userForUserDto(User user);
    @Mappings({
            @Mapping(target = "id",source = "id"),
            @Mapping(target = "userName",source = "userName"),
            @Mapping(target = "password",source = "password"),
            @Mapping(target = "email",source = "email")
    })
    List<User> UserDTOListForUserList(List<UserDTO> userDtoList);
    @Mappings({
            @Mapping(target = "id",source = "id"),
            @Mapping(target = "userName",source = "userName"),
            @Mapping(target = "password",source = "password"),
            @Mapping(target = "email",source = "email")
    })
    List<UserDTO> UserListForUserDTOList(List<User> userList);
}
```

#### éªŒè¯
- controllerå±‚
```java
@RestController
public class UserController {
    @Autowired
    UserService userService;

//    ç”¨æˆ·æ³¨å†Œ
    @PostMapping(value = "/reg",produces = "application/json")
    String registerUser(@RequestBody UserDTO user){

        return userService.register(user);
    }
    //    ç”¨æˆ·æ›´æ”¹ä¿¡æ¯
    @PostMapping(value = "/update",produces = "application/json")
    String updateUser(@RequestBody UserDTO user){
        return userService.update(user);
    }

    //    ç”¨æˆ·æ³¨é”€
    @PostMapping(value = "/dele",produces = "application/json")
    String deleteUser(@RequestBody UserDTO user){
        return userService.delete(user);
    }
    //    ç”¨æˆ·æŸ¥è¯¢
    @PostMapping(value = "/find",produces = "application/json")
    List<UserDTO> findUser(@RequestBody UserDTO user){
        return userService.find(user);

    }
}
```

- serviceå±‚
```java
package top.testeru.sbm.service.impl;

import cn.hutool.core.bean.BeanUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import tk.mybatis.mapper.entity.Example;
import top.testeru.sbm.converter.UserConverter;
import top.testeru.sbm.dao.UserMapper;
import top.testeru.sbm.dto.UserDTO;
import top.testeru.sbm.entity.User;
import top.testeru.sbm.service.UserService;


import java.util.Date;
import java.util.List;

/**
 * @program: springboot-turorials
 * @author: testeru.top
 * @description:
 * @Version 1.0
 * @create: 2022/5/17 2:38 PM
 */

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    UserMapper userMapper;

    @Autowired
    UserConverter converter;

    @Override
    public String register(UserDTO userDto) {
        User user = converter.userDtoForUser(userDto);
        List<User> byNameUser = findByName(user);
        if(byNameUser.size()==0){
            System.out.println(user);
            user.setCreateTime(new Date());
            user.setUpdateTime(new Date());
            user.setFlag(0);
            //ä¿å­˜ä¸€ä¸ªå®ä½“ï¼Œnullçš„å±æ€§ä¸ä¼šä¿å­˜ï¼Œä¼šä½¿ç”¨æ•°æ®åº“é»˜è®¤å€¼
            int insertNum = userMapper.insertSelective(user);
            System.out.println("æ’å…¥ " + insertNum + "æ¡æ•°æ®");
            if(insertNum >0){
                return "æ³¨å†ŒæˆåŠŸ";
            }
            return "æ³¨å†Œå¤±è´¥";
        }else {
            return "è¯¥ç”¨æˆ·åå·²ç»æ³¨å†Œ";
        }

    }

    @Override
    public List<UserDTO> find(UserDTO userDto) {
        User user = converter.userDtoForUser(userDto);
        List<User> userList = findByName(user);
        return converter.UserListForUserDTOList(userList);

    }


    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
     * @param
     * @return
     */
    private List<User> findByName(User user) {
        Example example = new Example(User.class);
        Example.Criteria criteria = example.createCriteria();
        criteria.andEqualTo("userName", user.getUserName());
        criteria.andEqualTo("flag", 0);
        List<User> userList = userMapper.selectByExample(example);
        System.out.println("userlist:");
        userList.forEach(System.out::println);
        return userList;
    }

    @Override
    public String delete(UserDTO userDTO) {

        return upAndDele(userDTO,"del");
    }



    @Override
    public String update(UserDTO userDto) {

        return upAndDele(userDto,"up");
    }


    private String upAndDele(UserDTO userDto, String str) {
        User user = converter.userDtoForUser(userDto);
        List<User> byNameUser = findByName(user);

        if("up".equals(str)){
            str = "æ›´æ–°ç”¨æˆ·";
        }else if("del".equals(str)){
            str = "åˆ é™¤ç”¨æˆ·";
            user.setFlag(1);
            user.setEmail(null);
            user.setPassword(null);
        }


        if(byNameUser.size()!=0){
            //æ”¾å…¥ä¸»é”®
            user.setId(byNameUser.get(0).getId());
            //æ›´æ–°çš„æ—¶é—´
            user.setUpdateTime(new Date());
            System.out.println(user);
            int updateNum = userMapper.updateByPrimaryKeySelective(user);
            System.out.println("æ›´æ”¹ " + updateNum + "æ¡æ•°æ®");
            if(updateNum >0){
                return str + "æˆåŠŸ";
            }
            return str + "å¤±è´¥";
        }else {
            return "è¯¥ç”¨æˆ·ä¸å­˜åœ¨";
        }
    }
}

```