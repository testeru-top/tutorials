# testeru-ad-impl
## 依赖添加
- mysql 是 8.*
- mybatis-plus 是 3.5.1
- springboot 是 2.6.3
- springcloud 是 2021.0.1

```xml
    <dependencies>
        <dependency>
            <groupId>top.testeru</groupId>
            <artifactId>testeru-ad-api</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

<!--        springbooot 暴露外部接口的-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>


<!--        注册给eureka-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>

<!--        获取配置中心的配置-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-client</artifactId>
        </dependency>


        <!-- druid 连接池-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
        </dependency>


        <!-- mysql连接 -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>

        </dependency>

        <!-- mybatis-plus-boot-starter 对mybatis框架的一个增强-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.1</version>
        </dependency>


        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>

        <!-- mybatis-plus-generator 自动代码生成工具-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-generator</artifactId>
            <version>3.5.1</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-core</artifactId>
            <version>3.5.1</version>
        </dependency>
        <dependency>
            <groupId>org.apache.velocity</groupId>
            <artifactId>velocity-engine-core</artifactId>
            <version>2.0</version>
        </dependency>


        <!--  mybatis-plus-generator 自动代码生成的时候模板引擎配置 freemarker -->
        <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
        </dependency>

        <!--  通用工具项目依赖      -->
        <dependency>
            <groupId>top.testeru</groupId>
            <artifactId>testeru-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter</artifactId>
            <!--            对应添加的依赖的作用范围-->
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-bootstrap</artifactId>
        </dependency>
    </dependencies>
```
注意⚠️：
- 如果报错：
```
No spring.config.import property has been defined
 
Action:

Add a spring.config.import=configserver: property to your configuration.   
If configuration is not required add spring.config.import=optional:configserver: instead.
To disable this check, set spring.cloud.config.enabled=false or 
spring.cloud.config.import-check.enabled=false.
```
>依赖缺少，添加依赖就会启动成功
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

## 编写业务逻辑
### PromotionSpaceController
- 获取广告位
```java
@RestController
@RequestMapping("/ad/space")
public class PromotionSpaceController {

    @Autowired
    private PromotionSpaceService promotionSpaceService;


    //获取所有广告
    @RequestMapping("/getAllSpaces")
    public List<PromotionSpace> getAllSpaces(){
        List<PromotionSpace> spaceList = promotionSpaceService.list();

        return spaceList;

    }
}

```

### bootstrap.yml
- springboot配置文件
```yml
server:
  port: 8001
spring:
  application:
    name: testeru-ad

  cloud:
    config:
      uri: http://localhost:8090
      label: master
      profile: dev
      name: testeru-ad


#注册到Eureka服务中心
eureka:
  client:
    service-url:
      # 注册到集群，就把多个Eurekaserver地址使用逗号连接起来即可；注册到单实例（非集群模式），那就写一个就ok
      defaultZone: http://127.0.0.1:8761/eureka/
    #eureka client刷新本地缓存时间 默认30s
    registry-fetch-interval-seconds: 5
  instance:
    prefer-ip-address: true  #服务实例中显示ip，而不是显示主机名（兼容老的eureka版本）
    # 实例名称
    instance-id: ${spring.cloud.client.ip-address}:${spring.application.name}:${server.port}

```


### TesteruAdApplication
- 创建启动类
```java
package top.testeru.ad;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;


//springboot启动注解
@SpringBootApplication
//作为eureka客户端进行注册
@EnableDiscoveryClient
//整合Mybatis 扫描mapper包下的类
@MapperScan("top.testeru.ad.mapper")
public class TesteruAdApplication {

    public static void main(String[] args) {
        SpringApplication.run(TesteruAdApplication.class);
    }
}

```

- 启动服务
- 首先看eureka服务启动成功没有
- 看config配置服务启动成功没有
- 启动业务ad服务


![](https://gitee.com/javaTesteru/picgo/raw/master/images/testeru/testeru-top-module/202203041814076.png)



# testeru-ad-api

## 依赖添加
```

<parent>
    <artifactId>testeru-ad</artifactId>
    <groupId>top.testeru</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>

<dependencies>
<!--bean的一个依赖-->
   <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
        <version>3.1.1</version>
    </dependency>

   <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
    </dependency>
</dependencies>
```


## 编写对外暴露接口
### PromotionSpaceDTO
- 编写返回类型的实体类，和`impl`里面`entity`的成员变量一致
```java
package top.testeru.ad.dto;

import java.util.Date;
public class PromotionSpaceDTO {

    private static final long serialVersionUID = 1L;

    private Integer id;

    private String name;

    private String spaceKey;


    private Date createTime;


    private Date updateTime;

    private Integer isDel;
    
    //getter,setter
}
```



### AdRemoteService

- 对外暴露接口，外边服务访问该文件

```java
package top.testeru.ad.remote;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import top.testeru.ad.dto.PromotionSpaceDTO;

import java.util.List;

//远程调用接口
//name和testeru-ad-impl项目中的bootstrap.yml文件的spring.application.name的内容一致
@FeignClient(name = "testeru-ad",path = "/ad")//bean后端
public interface AdRemoteService {

    @GetMapping("/space/getAllSpace")
    List<PromotionSpaceDTO> getAllSpace();
}

```

### testeru-ad-api安装到本地仓库

```
mvn install
```

# 优化testeru-ad-impl

`top.testeru.ad.controller.PromotionSpaceController`可以删除，对应的需要创建新的实现类来进行替换

- 创建包`top.testeru.ad.remote`
- 在该包下创建实现类实现的controller的功能

```java
package top.testeru.ad.remote;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import top.testeru.ad.dto.PromotionSpaceDTO;
import top.testeru.ad.entity.PromotionSpace;
import top.testeru.ad.service.PromotionSpaceService;
import top.testeru.util.ConverUtil;

import java.util.List;


@RestController
@RequestMapping("/ad")//共同的访问路径
public class AdRemoteServiceImpl implements AdRemoteService {


    @Autowired
    private PromotionSpaceService promotionSpaceService;


    //获取所有广告
    @RequestMapping("/space/getAllSpaces")
    public List<PromotionSpaceDTO> getAllSpace(){
        List<PromotionSpace> spaceList = promotionSpaceService.list();

        //PromotionSpace PromotionSpaceDTO一一映射
        //属性之间拷贝的工具类
        List<PromotionSpaceDTO> promotionSpaceDTOS = ConverUtil.convertList(spaceList, PromotionSpaceDTO.class);
        return promotionSpaceDTOS;

    }

}

```

# testeru-boss
- 继承对应bom依赖 