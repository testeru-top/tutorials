# JUnit5 Parallel Execution
é»˜è®¤æƒ…å†µä¸‹ï¼Œ`JUnit Jupiter` æµ‹è¯•åœ¨å•ä¸ªçº¿ç¨‹ä¸­æŒ‰é¡ºåºè¿è¡Œã€‚



## æ•™å­¦ç›®æ ‡

- `Junit 5` å¹¶è¡Œæµ‹è¯•é…ç½®
- `@ResourceLock`è·å–å…±äº«èµ„æº


>åœ¨æœ¬ç¯‡æ–‡ç« ï¼Œä¸»è¦å¯¹ `Junit 5` å¹¶è¡Œæµ‹è¯•æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹çš„å‡ ç§é…ç½®ç¤ºä¾‹ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨`@ResourceLock`è·å–åŒæ­¥è®¿é—®ä»¥è·å–å…±äº«èµ„æºçš„ç¤ºä¾‹ã€‚
## ç›¸å…³ç¯å¢ƒ
ä» `Junit 5.3` å¼€å§‹å¯ä»¥æ‰§è¡Œå¹¶è¡Œæµ‹è¯•ï¼Œåˆ°ç›®å‰ä»ç„¶æ˜¯ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ã€‚ä½†æ˜¯å¹¶è¡Œæ‰§è¡Œè¿™ç¡®å®æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œå› ä¸ºï¼Œå¯ä»¥å‡å°‘è¿è¡Œå¤§é‡æµ‹è¯•é›†çš„æ‰§è¡Œæ—¶é—´ï¼Œå°¤å…¶æ˜¯è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹ã€ŒUIè‡ªåŠ¨åŒ–/æ¥å£è‡ªåŠ¨åŒ–ã€ã€‚

`Junit 5` è‡ªå·±æœ¬èº«æœ‰éå¸¸ç®€å•è€Œå¼ºå¤§çš„é…ç½®æ¥æ§åˆ¶==æµ‹è¯•ç±»==å’Œ==æµ‹è¯•æ–¹æ³•==çš„å¹¶å‘æ€§ã€‚`Junit 5` çš„ç‰¹æœ‰æ³¨è§£`@ResourceLock`æ˜¯==åŒæ­¥è®¿é—®å…±äº«èµ„æº==çš„å¥½åŠŸèƒ½ã€‚ä¸‹é¢ğŸ‘‡ç»™å¤§å®¶çœ‹ä¸€ä¸‹å…·ä½“å†…å®¹ã€‚
### ç¯å¢ƒé…ç½®
æœ¬ç¯‡æ–‡ç« ä½¿ç”¨çš„ç›¸å…³ç¯å¢ƒä¸ºï¼š
- Junit 5.8.2
- Maven 3.8.1
- Java 11

```xml
    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <java.version>11</java.version>
        <!-- ä½¿ç”¨ Java 11 è¯­è¨€ç‰¹æ€§ ( -source 11 ) å¹¶ä¸”è¿˜å¸Œæœ›ç¼–è¯‘åçš„ç±»ä¸ JVM 11 ( -target 11 )å…¼å®¹ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä»¥ä¸‹ä¸¤ä¸ªå±æ€§ï¼Œå®ƒä»¬æ˜¯é»˜è®¤å±æ€§æ’ä»¶å‚æ•°çš„åç§°-->
        <maven.compiler.target>11</maven.compiler.target>
        <maven.compiler.source>11</maven.compiler.source>
        <!-- å¯¹åº”junit Jupiterçš„ç‰ˆæœ¬å·;æ”¾åœ¨è¿™é‡Œå°±ä¸éœ€è¦åœ¨æ¯ä¸ªä¾èµ–é‡Œé¢å†™ç‰ˆæœ¬å·ï¼Œå¯¼è‡´å¯¹åº”ç‰ˆæœ¬å·ä¼šå†²çª-->
        <junit.jupiter.version>5.8.2</junit.jupiter.version>

        <maven.compiler.version>3.8.1</maven.compiler.version>
        <maven.surefire.version>3.0.0-M5</maven.surefire.version>
        <!-- plugins -->
        <maven-surefire-plugin.version>3.0.0-M5</maven-surefire-plugin.version>
        <poi.version>5.2.2</poi.version>
    </properties>

    <!--    ç‰©æ–™æ¸…å• (BOM)-->
    <dependencyManagement>
        <dependencies>
            <!--å½“ä½¿ç”¨ Gradle æˆ– Maven å¼•ç”¨å¤šä¸ª JUnit å·¥ä»¶æ—¶ï¼Œæ­¤ç‰©æ–™æ¸…å• POM å¯ç”¨äºç®€åŒ–ä¾èµ–é¡¹ç®¡ç†ã€‚ä¸å†éœ€è¦åœ¨æ·»åŠ ä¾èµ–æ—¶è®¾ç½®ç‰ˆæœ¬-->
            <dependency>
                <groupId>org.junit</groupId>
                <artifactId>junit-bom</artifactId>
                <version>${junit.jupiter.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter</artifactId>
            <!--            å¯¹åº”æ·»åŠ çš„ä¾èµ–çš„ä½œç”¨èŒƒå›´-->
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.junit.platform</groupId>
            <artifactId>junit-platform-suite</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.junit.vintage</groupId>
            <artifactId>junit-vintage-engine</artifactId>
<!--            <version>${junit.jupiter.version}</version>-->
        </dependency>

        <dependency>
            <groupId>org.hamcrest</groupId>
            <artifactId>hamcrest-all</artifactId>
            <version>1.3</version>
            <scope>test</scope>
        </dependency>
    </dependencies>


    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>${maven-surefire-plugin.version}</version>
                <configuration>
<!--                    <includes>-->
<!--                        <include>top/testeru/group/*_Test.class</include>-->
<!--                    </includes>-->
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>org.junit.jupiter</groupId>
                        <artifactId>junit-jupiter-engine</artifactId>
                        <version>${junit.jupiter.version}</version>
                    </dependency>
                    <dependency>
                        <groupId>org.junit.vintage</groupId>
                        <artifactId>junit-vintage-engine</artifactId>
                        <version>${junit.jupiter.version}</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
```


## ç”¨ä¾‹å‡†å¤‡
ä¸ºäº†æ¼”ç¤ºå¹¶å‘æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸‰ä¸ªæµ‹è¯•ç±»ï¼Œæ¯ä¸ªæµ‹è¯•ç±»é‡Œé¢æœ‰4ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```java
public class Parallel1_Test {
    @Test
    void test1(){
        System.out.println(Thread.currentThread().getName()+" => Parallel1_Test--test1");
    }
    @Test
    void test2(){
        System.out.println(Thread.currentThread().getName()+" => Parallel1_Test--test2");
    }
    @Test
    void test3(){
        System.out.println(Thread.currentThread().getName()+" => Parallel1_Test--test3");
    }
}
```

```java
public class Parallel2_Test {
    @Test
    void test1(){
        System.out.println(Thread.currentThread().getName()+" => Parallel2_Test--test1");
    }
    @Test
    void test2(){
        System.out.println(Thread.currentThread().getName()+" => Parallel2_Test--test2");
    }
    @Test
    void test3(){
        System.out.println(Thread.currentThread().getName()+" => Parallel2_Test--test3");
    }
}
```



```java
public class Parallel3_Test {
    @Test
    void test1(){
        System.out.println(Thread.currentThread().getName()+" => Parallel3_Test--test1");
    }

    @Test
    void test2(){
        System.out.println(Thread.currentThread().getName()+" => Parallel3_Test--test2");
    }

    @Test
    void test3(){
        System.out.println(Thread.currentThread().getName()+" => Parallel3_Test--test3");
    }
}
```
![](https://cdn.jsdelivr.net/gh/testeru-top/images/tester/202206131815436.png)

**åœ¨æ²¡æœ‰é…ç½®å¹¶å‘ç›¸å…³é…ç½®çš„æƒ…å†µä¸‹å¯¹åº”ä»£ç è¿è¡Œï¼š**
![](https://cdn.jsdelivr.net/gh/testeru-top/images/tester/202206131824115.png)
- å¦‚æœæ²¡æœ‰å¹¶å‘é…ç½®ï¼Œé»˜è®¤å°±æ˜¯ä¸»ã€Œ`main`ã€çº¿ç¨‹è¿è¡Œã€‚
## å¹¶è¡Œæ­¥éª¤
å¦‚æœæƒ³è¦å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œå¹¶å‘çš„æ‰§è¡Œï¼Œéœ€è¦é…ç½®å¹¶è¡Œæµ‹è¯•çš„`parallel`å‚æ•°ã€‚å³ï¼Œ`junit.jupiter.execution.parallel.enabled`çš„å€¼è®¾ç½®ä¸º`true`ã€‚è¿™ä¸ªå‚æ•°çš„å«ä¹‰å°±æ˜¯ï¼Œå‘Šè¯‰JUnit5æ¡†æ¶è¦æ‰“å¼€å¹¶è¡Œæµ‹è¯•çš„æŒ‰é’®äº†ã€‚

#### æ³¨æ„
å¯ç”¨æ­¤å±æ€§åªæ˜¯å¹¶è¡Œæ‰§è¡Œæµ‹è¯•æ‰€éœ€çš„ç¬¬ä¸€æ­¥ã€‚

- å¦‚æœå¯ç”¨ï¼Œé»˜è®¤æƒ…å†µä¸‹++æµ‹è¯•ç±»å’Œæ–¹æ³•ä»å°†æŒ‰é¡ºåºæ‰§è¡Œ++ã€‚
>è¿™ä¸ªæ—¶å€™åªæ˜¯æŠŠå¹¶è¡Œæµ‹è¯•çš„æŒ‰é’®å¯åŠ¨å¼€äº†ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œä¸€ä¸ªå¹¶è¡Œæµ‹è¯•çš„æ‰§è¡Œã€‚

#### parallelé…ç½®

å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼æ¥è¿›è¡Œ`JUnit5` å¼€å¯ `parallel` çš„é…ç½®ï¼š

- åœ¨`JUnit5`çš„é…ç½®æ–‡ä»¶ã€Œ`junit-platform.properties`ã€è¿›è¡Œé…ç½®  (æœ€ç®€å•çš„æ–¹æ³•)

```
junit.jupiter.execution.parallel.enabled=true
```
- é€šè¿‡å‘ `maven surefire` æ’ä»¶æä¾›å‚æ•°
- é€šè¿‡å‘ `JVM` æä¾›ç³»ç»Ÿå±æ€§


>æˆ‘ä»¬å…ˆç”¨`JUnit5`çš„é…ç½®æ–‡ä»¶æ¥è¿›è¡Œè¯´æ˜æ¼”ç¤ºï¼Œåé¢ä¼šè¡¥å…… `maven surefire` æ’ä»¶å’Œå‘`JVM` æä¾›ç³»ç»Ÿå±æ€§ä½¿ç”¨æ–¹æ³•ã€‚

### 1.JUnit5é…ç½®æ–‡ä»¶åˆ›å»º

- åœ¨é¡¹ç›®çš„`src/test/resources`ç›®å½•ä¸‹åˆ›å»º`JUnit5`çš„é…ç½®æ–‡ä»¶ï¼š`junit-platform.properties`


### 2.å¹¶è¡Œæµ‹è¯•é…ç½®
- ä»¥ä¸‹é…ç½®æ”¾å…¥JUnit5é…ç½®æ–‡ä»¶ä¸­ï¼š
```
junit.jupiter.execution.parallel.enabled=true
```



#### è¿è¡Œ

![](https://cdn.jsdelivr.net/gh/testeru-top/images/tester/202206131835900.png)

åœ¨è¿™ä¸ªè¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ä¸¤ä»¶äº‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çš„**æµ‹è¯•æŒ‰é¡ºåºè¿è¡Œ**ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬**ä½¿ç”¨ForkJoinçº¿ç¨‹æ± **ã€‚é€šè¿‡å¯ç”¨å¹¶è¡Œæ‰§è¡Œï¼Œ**JUnit 5å¼•æ“å¼€å§‹ä½¿ç”¨ ForkJoin çº¿ç¨‹æ± **ã€‚

ä¹Ÿå°±æ˜¯è¿™ä¸ªé…ç½®åªæ˜¯è¯´æ˜ä½¿ç”¨äº†çº¿ç¨‹æ± ï¼Œå¹¶æ²¡æœ‰è¯´æ˜æ˜¯å¹¶è¡Œæ‰§è¡Œã€‚

>åªæ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†`parallel`ï¼Œåˆ™è¡¨æ˜äº†æ‰“å¼€å¹¶å‘æ± ï¼Œå¯ä»¥æ‰§è¡Œå¹¶è¡Œæµ‹è¯•äº†ã€‚
>ä½†æ˜¯ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å‘Šè¯‰`JUnit 5`åº”è¯¥æ€æ ·å»è¿è¡Œè¿™ä¸ªå¹¶å‘ï¼Œæ˜¯æŒ‰æµ‹è¯•ç±»æ¥è¿›è¡Œå¹¶å‘æ‰§è¡Œè¿˜æ˜¯æŒ‰æµ‹è¯•æ–¹æ³•æ¥è¿›è¡Œå¹¶å‘æ‰§è¡Œå‘¢ï¼Ÿè¿™ä¸ªåœ¨é…ç½®æ–‡ä»¶æ˜¯æ²¡æœ‰è¿›è¡Œä¸€ä¸ªè¯´æ˜é…ç½®çš„ã€‚
>æ‰€ä»¥ï¼Œè¿è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼Œåªæ˜¯å¯¹åº”çš„çº¿ç¨‹åç§°ä»*ä¸»çº¿ç¨‹* `main`å˜æˆäº†*çº¿ç¨‹æ± *`ForkJoinPool-1-worker-19`ï¼Œä½†æ˜¯æ— è®ºæ˜¯è¿è¡Œçš„++æµ‹è¯•ç±»++è¿˜æ˜¯++æµ‹è¯•æ–¹æ³•++éƒ½æ˜¯ç”¨çš„çº¿ç¨‹æ± é‡Œé¢çš„åŒä¸€ä¸ªçº¿ã€Œå½“å‰ç¤ºä¾‹é‡Œé¢ç”¨çš„æ˜¯çº¿ç¨‹æ± é‡Œçš„19ã€ã€‚






æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªé…ç½®æ¥åˆ©ç”¨è¿™ä¸ªçº¿ç¨‹æ± ã€‚æˆ‘ä»¬éœ€è¦é€‰æ‹©ä¸€ç§å¹¶è¡ŒåŒ–ç­–ç•¥ã€‚JUnit æä¾›äº†ä¸¤ç§å®ç°ï¼ˆåŠ¨æ€å’Œå›ºå®šï¼‰å’Œä¸€ä¸ªè‡ªå®šä¹‰é€‰é¡¹æ¥åˆ›å»ºæˆ‘ä»¬çš„å®ç°ã€‚

æµ‹è¯•æ ‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å¹¶å‘æ‰§è¡Œç”±å…¶æ‰§è¡Œæ¨¡å¼æ§åˆ¶ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ¨¡å¼ï¼š
#### SAME_THREAD
- å¼ºåˆ¶åœ¨çˆ¶çº§ä½¿ç”¨çš„åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

>ä¾‹å¦‚ï¼Œå½“è¯¥æ‰§è¡Œæ¨¡å¼åœ¨æµ‹è¯•æ–¹æ³•ä¸Šä½¿ç”¨æ—¶ï¼Œè¯¥æµ‹è¯•æ–¹æ³•å°†ä¸æµ‹è¯•ç±»çš„ `@BeforeAll` / `@AfterAll` æ–¹æ³•åœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

#### CONCURRENT
- å¹¶å‘æ‰§è¡Œï¼Œé™¤éèµ„æºé”å¼ºåˆ¶åœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œã€‚


é»˜è®¤æƒ…å†µä¸‹ï¼Œæµ‹è¯•æ ‘ä¸­çš„èŠ‚ç‚¹ä½¿ç”¨SAME_THREADæ‰§è¡Œæ¨¡å¼ã€‚junit.jupiter.execution.parallel.mode.defaultæ‚¨å¯ä»¥é€šè¿‡è®¾ç½®é…ç½®å‚æ•°æ¥æ›´æ”¹é»˜è®¤å€¼ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨@Executionæ³¨é‡Šæ¥æ›´æ”¹å¸¦æ³¨é‡Šçš„å…ƒç´ åŠå…¶å­å…ƒç´ ï¼ˆå¦‚æœæœ‰ï¼‰çš„æ‰§è¡Œæ¨¡å¼ï¼Œè¿™å…è®¸æ‚¨é€ä¸ªæ¿€æ´»å„ä¸ªæµ‹è¯•ç±»çš„å¹¶è¡Œæ‰§è¡Œã€‚


#### æµ‹è¯•ç±»å¹¶è¡Œé…ç½®
```
#å¯¹åº”ç±»é»˜è®¤å¹¶è¡Œ
junit.jupiter.execution.parallel.mode.classes.default = concurrent
```
![](https://cdn.jsdelivr.net/gh/testeru-top/images/tester/202206131847068.png)

é‡Œé¢æ²¡æœ‰æŒ‰ç…§ç±»æ¥è¿›è¡Œæ‰“å°ï¼Œæˆ‘è¿™é‡Œç»™å¤§å®¶è§„èŒƒäº†ä¸€ä¸‹ï¼Œå¦‚ä¸‹ğŸ‘‡ï¼š

```
ForkJoinPool-1-worker-9 => Parallel1_Test--test1
ForkJoinPool-1-worker-9 => Parallel1_Test--test2
ForkJoinPool-1-worker-9 => Parallel1_Test--test3

ForkJoinPool-1-worker-5 => Parallel2_Test--test1
ForkJoinPool-1-worker-5 => Parallel2_Test--test2
ForkJoinPool-1-worker-5 => Parallel2_Test--test3

ForkJoinPool-1-worker-23 => Parallel3_Test--test1
ForkJoinPool-1-worker-23 => Parallel3_Test--test2
ForkJoinPool-1-worker-23 => Parallel3_Test--test3
```
##### ç»“è®º
>ä¸åŒçš„ç±»ä½¿ç”¨ä¸åŒçº¿ç¨‹è¿›è¡Œè¿è¡Œï¼Œä½†æ˜¯åŒä¸€ä¸ªç±»é‡Œé¢çš„æ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹
- å®ç°äº†å¤šä¸ªæµ‹è¯•ç±»è¿›è¡Œå¹¶è¡Œæµ‹è¯•
#### æµ‹è¯•æ–¹æ³•å¹¶è¡Œé…ç½®
```
#å¯¹åº”ç±»é»˜è®¤å¹¶è¡Œ
junit.jupiter.execution.parallel.mode.classes.default = concurrent
```

![](https://cdn.jsdelivr.net/gh/testeru-top/images/tester/202206131855078.png)

åŒæ ·ï¼Œé‡Œé¢æ²¡æœ‰æŒ‰ç…§ç±»æ¥è¿›è¡Œæ‰“å°ï¼Œæˆ‘è¿™é‡Œç»™å¤§å®¶è§„èŒƒäº†ä¸€ä¸‹ï¼Œå¦‚ä¸‹ğŸ‘‡ï¼š

```
ForkJoinPool-1-worker-31 => Parallel1_Test--test1
ForkJoinPool-1-worker-15 => Parallel1_Test--test2
ForkJoinPool-1-worker-9 => Parallel1_Test--test3

ForkJoinPool-1-worker-13 => Parallel2_Test--test1
ForkJoinPool-1-worker-3 => Parallel2_Test--test2
ForkJoinPool-1-worker-11 => Parallel2_Test--test3

ForkJoinPool-1-worker-27 => Parallel3_Test--test1
ForkJoinPool-1-worker-17 => Parallel3_Test--test2
ForkJoinPool-1-worker-21 => Parallel3_Test--test3
```


##### ç»“è®º
>ä¸åŒçš„ç±»å†…çš„æ–¹æ³•ä½¿ç”¨ä¸åŒçº¿ç¨‹è¿›è¡Œè¿è¡Œï¼Œä¸åŒçš„ç±»ä¹Ÿæ˜¯å¹¶è¡Œæµ‹è¯•
- å®ç°äº†å¤šä¸ªæµ‹è¯•æ–¹æ³•è¿›è¡Œå¹¶è¡Œæµ‹è¯•



|  |  |  |
| -------------------------------- | ---------------------------- | -------------------------- |
|  åˆšå‘çš„                         | mode.default=same_thread  ã€Œæµ‹è¯•æ–¹æ³•å•çº¿ç¨‹ã€   | mode.default=concurrent   ã€Œæµ‹è¯•æ–¹æ³•å¹¶å‘ã€ |
| mode.classes.default=same_thread ã€Œæµ‹è¯•ç±»å•çº¿ç¨‹ã€| æµ‹è¯•æ–¹æ³•å•çº¿ç¨‹ï¼Œæµ‹è¯•ç±»å•çº¿ç¨‹ | æµ‹è¯•æ–¹æ³•å¹¶å‘ï¼Œæµ‹è¯•ç±»å•çº¿ç¨‹ |
|       mode.classes.default=concurrent   ã€Œæµ‹è¯•ç±»å¹¶å‘ã€      |    æµ‹è¯•æ–¹æ³•å•çº¿ç¨‹ï¼Œ æµ‹è¯•ç±»å¹¶å‘    |  æµ‹è¯•æ–¹æ³•å¹¶å‘ï¼Œæµ‹è¯•ç±»å¹¶å‘ |